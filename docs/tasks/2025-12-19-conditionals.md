# Task: Code generation for if-then-else

## Goal

The goal is to compile `<if>E1 E2 E3</if>` into this, where `[E]` is the
sequence of instructions generated by compiling `E`.

```
<stack.length index=TMPVAR/>
[E1]
<check.bool index=TMPVAR/>
<if.not value=ELSE_LABEL/>
[E2]
<goto value=END_LABEL/>
<label value=ELSE_LABEL/>
[E3]
<label value=END_LABEL/>
```

## Labels

### Structure

Labels are more-or-less represented by text-strings. But actually we will be
using an encoded ADT:

```go
type LabelType int

const (
    SimpleLabel = iota
    ContineLabel
    ReturnLabel
)


type struct Label {
    labelType LabelType,
    labelText string
}
```

The corresponding ADT is (of course):

```
datatype Label = SimpleLabel(string) | ContinueLabel | ReturnLabel;
```

Simple labels correspond to the ordinary use of labels that you can jump to as
a target. But ContinueLabels correspond to drop-thru and ReturnLabels will be
translated into an immediate return.

### Allocating Simple Labels

The FnCodeGenState will need to be able to allocate a series of unique
SimpleLabels. To do that it will need an auto-incrementing counter.

### Label Resolution

Labels are turned into relative jumps by the Nutmeg-runtime rather than the
compiler. This is to allow the runtime to control the implementation of the
instructions.

## Compilation

The predicate part of the conditions (`E1`) will be compiled as a _query_, a
concept that will become increasingly prevalent as we continue working on 
Nutmeg. Queries are expression-like terms that succeed, with variable bindings
being established, or fail. As a result they are always called with two labels, 
one for success and the other for failure.

In the case of an if-expression, we allocate two simple labels ahead of time - the
ELSE_LABEL and the END_LABEL. The predicate is compiled with a ContinueLabel
for the success case and the simple ELSE_LABEL.

Compiling a query, for the moment, boils down to compiling an expression with
a check for a single value that is boolean, comparing SPECIAL_FALSE and branching
to failure or success accordingly (note it is flipped).

The compilation of a conditional jump to one of two targets inspects the
label types. In this case, we have jump-on-failure, so we generate an `<if.not>`
instruction with the ELSE_LABEL.

